################################################################################
# Nginx ‑ default.conf
# ─────────────────────────────────────────────────────────────────────────────
# ローカル開発用のマルチ‑Laravel構成
#
#   http://localhost/            →  共通フロント  (my‑app/public)
#   http://localhost/agent/      →  agent アプリ  (my‑app/agent/public)
#   http://localhost/language/   →  language アプリ (my‑app/language/public)
#
# ─────────────────────────────────────────────────────────────────────────────
# ❶ map で「アクセスされた URI」→「実際の public ディレクトリ」へ変換
# ❷ server ブロック内で $app_root を使ってルートを動的に切り替え
################################################################################

# ❶ URI に応じた public ディレクトリのマッピング
map $uri $app_root {
    default         /var/www/public;               # ルート／その他パス → 共通 public
    ~^/agent/       /var/www/agent/public;         # /agent/*           → agent アプリ
    ~^/language/    /var/www/language/public;      # /language/*        → language アプリ
}

# ❷ サーバーブロック
server {
    listen 80;                         # コンテナ内 80 番で待受（docker でホストポートにマッピング）
    server_name localhost;             # 開発用ホスト名

    # この root は fallback 用。実際のドキュメントルートは $app_root で上書きされる
    root /var/www/public;
    index index.php index.html;
    charset utf-8;

    # ───── ログ ──────────────────────────────────────────
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/errors/error.log;

    ########################################################################
    #  /  : 共通フロント（my‑app/public）を表示
    ########################################################################
    location = / {
        root   $app_root;                              # /var/www/public
        index index.php index.html;         　　　      # 優先ファイル
        try_files $uri $uri/ /index.php?$query_string;

        # PHP (FastCGI) 設定
        location ~ \.php$ {
            root   $app_root;
            try_files $uri =404;
            include fastcgi_params;
            fastcgi_pass  php:9000;                    # docker‑compose の php サービス
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO       $fastcgi_path_info;
        }
    }

    ########################################################################
    #  /agent/*  /language/* : 個別 Laravel アプリ
    ########################################################################
    location ~ ^/(agent|language)/ {
        root  $app_root;                               # map が自動で切替
        try_files $uri $uri/ /index.php?$query_string;

        location ~ \.php$ {
            root  $app_root;
            try_files $uri =404;
            include fastcgi_params;
            fastcgi_pass  php:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO       $fastcgi_path_info;
        }
    }

    ########################################################################
    #  静的アセット (画像/JS/CSS など) 30 日キャッシュ
    ########################################################################
    location ~* \.(?:jpg|jpeg|png|gif|ico|svg|css|js|woff2?|ttf|eot)$ {
        root $app_root;
        access_log  off;
        expires 30d;
    }

    ########################################################################
    #  セキュリティ : .ht* ファイルは公開しない
    ########################################################################
    location ~ /\.ht {
        deny all;
    }
}
