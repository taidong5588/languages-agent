# ========================================
# URI に応じて、対応する Laravel アプリの public ディレクトリを変数に割り当てる
# ========================================
map $uri $app_root {
    default         /var/www/public;               # デフォルト：共通 public ディレクトリ
    ~^/agent/       /var/www/agent/public;         # /agent にマッチした場合
    ~^/language/    /var/www/language/public;      # /language にマッチした場合
}

# ========================================
# Nginx サーバーブロック定義（ローカル開発環境用）
# ========================================
server {
    listen 80;                                     # 通常のHTTPポート
    server_name localhost;                         # ローカル開発環境ホスト名

    root /var/www/public;                          # ドキュメントルート（初期値）
    index index.php index.html;                    # 優先的に探すファイル
    charset utf-8;                                  # 文字コード指定

    # ログ出力先（エラーログ／アクセスログ）
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/errors/error.log;

    # ========================================
    # 共通のルート "/" にアクセスされた場合の処理
    # （→ my-app/public/index.php を表示）
    # ========================================
    location / {
        root $app_root;                             # → /var/www/public を使用
        index index.php index.html;                # 優先ファイル
        try_files $uri $uri/ /index.php?$query_string;  # ファイル存在確認 → Laravelルーティング

        # ====================================
        # PHP ファイルの実行処理（FastCGI）
        # ====================================
        location ~ \.php$ {
            root $app_root;                         # PHP実行対象ディレクトリ
            try_files $uri =404;                    # ファイルが存在しない場合404
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            include fastcgi_params;
            fastcgi_pass php:9000;                  # php（php-fpmコンテナ）に処理を渡す
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;  # 実行対象ファイル
            fastcgi_param PATH_INFO $fastcgi_path_info;                         # 任意の追加情報
        }
    }

    # ========================================
    # Laravel サブアプリ（/agent, /language）へのアクセス
    # （それぞれの public/index.php がルートになる）
    # ========================================
    location ~ ^/(agent|language)/ {
        root $app_root;                             # map によって切り替わるアプリパス
        index index.php index.html;
        try_files $uri $uri/ /index.php?$query_string;

        # PHP 実行設定
        location ~ \.php$ {
            root $app_root;
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            include fastcgi_params;
            fastcgi_pass php:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
        }
    }

    # ========================================
    # 静的ファイル（画像・CSS・JSなど）の処理
    # キャッシュ制御なども含む
    # ========================================
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        root $app_root;
        access_log off;                             # 静的ファイルへのアクセスログを無効化
        expires 30d;                                # ブラウザキャッシュ30日
    }

    # ========================================
    # セキュリティ対策：.htaccess などのファイルアクセス禁止
    # Laravel では使用されないが、Apache 互換対策
    # ========================================
    location ~ /\.ht {
        deny all;
    }
}
